#include "frame.h"
#include "mem.h"
#include "graphic.h"
#include "comm/config.h"
#include "tool.h"
#include "file.h"
#include "comm/math.h"

static frame_t *frames[FRAME_COUNT];
static uint16_t curr_order;
static uint8_t *merge_vram; // 绘制时先合并绘制到这里，再绘制到屏幕防止闪烁

// 备用
//static uint8_t cursor[]={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x00,0xFF,0xFF,0xFF,0x00,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x07,0x07,0x07,0x07,0x00,0x00,0x07,0x07,0x07,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x07,0x07,0x07,0x00,0xFF,0xFF,0x00,0x07,0x07,0x07,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x07,0x07,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x07,0x07,0x07,0x00,0xFF,0xFF,0xFF,0x00,0x07,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x07,0x07,0x07,0x00,0xFF,0xFF,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x07,0x07,0x07,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x07,0x07,0x07,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x07,0x07,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00};
//static uint8_t close[]={0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x00,0x07,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x0F,0x00,0x07,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x0F,0x00,0x07,0x08,0x08,0x08,0x00,0x00,0x08,0x08,0x08,0x08,0x00,0x00,0x08,0x08,0x0F,0x00,0x07,0x08,0x08,0x08,0x08,0x00,0x00,0x08,0x08,0x00,0x00,0x08,0x08,0x08,0x0F,0x00,0x07,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x0F,0x00,0x07,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x0F,0x00,0x07,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x0F,0x00,0x07,0x08,0x08,0x08,0x08,0x00,0x00,0x08,0x08,0x00,0x00,0x08,0x08,0x08,0x0F,0x00,0x07,0x08,0x08,0x08,0x00,0x00,0x08,0x08,0x08,0x08,0x00,0x00,0x08,0x08,0x0F,0x00,0x07,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x0F,0x00,0x07,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x0F,0x00,0x07,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
//static uint8_t img[]={0x10,0x10,0x10,0x10,0x11,0x12,0x13,0x13,0x14,0x13,0x15,0x16,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x18,0x13,0x13,0x13,0x10,0x10,0x10,0x19,0x12,0x12,0x1a,0x1b,0x12,0x1c,0x16,0x17,0x17,0x17,0x17,0x16,0x16,0x16,0x1d,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x1b,0x13,0x13,0x13,0x13,0x10,0x10,0x1e,0x13,0x12,0x12,0x1b,0x1a,0x1c,0x16,0x17,0x17,0x17,0x17,0x16,0x17,0x17,0x17,0x17,0x16,0x17,0x17,0x17,0x17,0x17,0x17,0x11,0x13,0x13,0x12,0x12,0x12,0x10,0x10,0x11,0x12,0x12,0x12,0x11,0x15,0x16,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x1f,0x20,0x20,0x17,0x17,0x20,0x20,0x20,0x14,0x12,0x12,0x12,0x12,0x12,0x10,0x10,0x11,0x12,0x12,0x13,0x14,0x16,0x21,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x20,0x22,0x22,0x20,0x20,0x22,0x22,0x20,0x1b,0x12,0x12,0x13,0x12,0x11,0x10,0x10,0x11,0x12,0x12,0x13,0x16,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x20,0x22,0x22,0x23,0x24,0x25,0x22,0x20,0x11,0x13,0x13,0x13,0x11,0x26,0x10,0x10,0x10,0x1e,0x12,0x13,0x16,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x20,0x22,0x20,0x20,0x20,0x20,0x22,0x20,0x11,0x13,0x13,0x13,0x1b,0x17,0x10,0x10,0x10,0x10,0x19,0x27,0x17,0x17,0x17,0x28,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x17,0x20,0x20,0x17,0x29,0x17,0x17,0x20,0x20,0x11,0x13,0x13,0x13,0x1b,0x17,0x10,0x10,0x10,0x10,0x10,0x27,0x21,0x17,0x28,0x17,0x17,0x17,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x28,0x21,0x17,0x21,0x21,0x11,0x13,0x13,0x13,0x1b,0x17,0x10,0x10,0x10,0x10,0x27,0x28,0x28,0x17,0x28,0x17,0x17,0x17,0x2a,0x21,0x21,0x21,0x21,0x21,0x21,0x21,0x2b,0x27,0x2c,0x17,0x17,0x2c,0x11,0x13,0x13,0x13,0x11,0x21,0x10,0x10,0x10,0x10,0x2c,0x28,0x28,0x28,0x2a,0x28,0x17,0x17,0x2a,0x21,0x21,0x21,0x21,0x17,0x28,0x17,0x27,0x2d,0x2d,0x2e,0x27,0x2d,0x2d,0x11,0x13,0x13,0x13,0x11,0x10,0x10,0x10,0x27,0x28,0x28,0x28,0x28,0x2b,0x2a,0x28,0x28,0x2a,0x21,0x21,0x21,0x21,0x17,0x28,0x28,0x27,0x2d,0x2d,0x23,0x2f,0x2d,0x2d,0x11,0x13,0x13,0x13,0x1e,0x10,0x10,0x10,0x27,0x2a,0x2a,0x28,0x28,0x2b,0x28,0x28,0x28,0x2a,0x2a,0x2a,0x2a,0x2a,0x2a,0x2a,0x2a,0x27,0x2d,0x27,0x27,0x27,0x27,0x2d,0x11,0x12,0x13,0x13,0x13,0x10,0x10,0x10,0x27,0x2a,0x28,0x28,0x27,0x30,0x27,0x2a,0x2a,0x27,0x28,0x28,0x28,0x28,0x28,0x2b,0x2a,0x27,0x27,0x2a,0x2a,0x2a,0x31,0x2c,0x2c,0x11,0x12,0x13,0x13,0x10,0x10,0x10,0x27,0x28,0x28,0x28,0x27,0x10,0x27,0x2a,0x32,0x27,0x28,0x28,0x28,0x28,0x28,0x2b,0x2a,0x2a,0x27,0x28,0x28,0x2a,0x33,0x34,0x17,0x21,0x11,0x1a,0x13,0x10,0x10,0x10,0x27,0x28,0x28,0x28,0x27,0x35,0x34,0x34,0x2c,0x27,0x28,0x28,0x28,0x28,0x28,0x2b,0x2a,0x28,0x11,0x11,0x11,0x2a,0x33,0x11,0x19,0x11,0x26,0x11,0x12,0x10,0x10,0x10,0x27,0x28,0x28,0x28,0x27,0x35,0x36,0x37,0x34,0x27,0x27,0x27,0x27,0x27,0x34,0x34,0x34,0x34,0x19,0x13,0x13,0x1b,0x11,0x1a,0x12,0x11,0x21,0x21,0x38,0x10,0x10,0x10,0x27,0x2a,0x28,0x28,0x27,0x23,0x36,0x37,0x34,0x10,0x10,0x10,0x10,0x35,0x23,0x36,0x39,0x37,0x11,0x13,0x13,0x23,0x3a,0x1a,0x12,0x11,0x26,0x21,0x1d,0x10,0x10,0x10,0x27,0x2a,0x2a,0x2a,0x27,0x23,0x3b,0x3c,0x35,0x3d,0x3d,0x3d,0x3d,0x23,0x23,0x36,0x37,0x37,0x11,0x12,0x11,0x14,0x14,0x11,0x12,0x11,0x26,0x17,0x16,0x10,0x10,0x10,0x27,0x2a,0x2a,0x2a,0x27,0x23,0x3b,0x3c,0x35,0x3d,0x3d,0x3d,0x3d,0x23,0x23,0x3b,0x3c,0x3c,0x11,0x11,0x2a,0x28,0x2d,0x3e,0x11,0x11,0x26,0x16,0x16,0x10,0x10,0x10,0x27,0x2a,0x2a,0x2a,0x27,0x10,0x35,0x34,0x10,0x3d,0x3d,0x3d,0x3d,0x23,0x3f,0x40,0x3c,0x3c,0x3f,0x28,0x28,0x28,0x2d,0x10,0x3d,0x34,0x41,0x16,0x16,0x10,0x10,0x10,0x27,0x2a,0x2a,0x2a,0x27,0x30,0x10,0x3d,0x42,0x3d,0x3d,0x3d,0x3d,0x43,0x10,0x34,0x35,0x34,0x2c,0x28,0x28,0x28,0x2d,0x10,0x3d,0x34,0x41,0x16,0x16,0x10,0x10,0x10,0x10,0x27,0x2a,0x2a,0x27,0x3d,0x3d,0x3d,0x3d,0x3d,0x3d,0x3d,0x3d,0x42,0x42,0x3d,0x10,0x10,0x2c,0x28,0x28,0x28,0x27,0x10,0x34,0x44,0x44,0x16,0x34,0x10,0x10,0x10,0x10,0x27,0x2a,0x2a,0x2a,0x34,0x3d,0x3d,0x3d,0x3d,0x3d,0x3d,0x3d,0x42,0x42,0x3d,0x3d,0x43,0x27,0x28,0x28,0x28,0x27,0x3f,0x16,0x44,0x44,0x34,0x20,0x10,0x10,0x10,0x10,0x2c,0x2a,0x2a,0x28,0x28,0x3f,0x3d,0x3d,0x3d,0x1b,0x3d,0x3d,0x11,0x3d,0x3d,0x3d,0x3d,0x27,0x28,0x28,0x28,0x27,0x16,0x16,0x44,0x35,0x10,0x20,0x10,0x10,0x10,0x10,0x2c,0x2a,0x2a,0x28,0x28,0x2c,0x34,0x35,0x3d,0x3d,0x1b,0x38,0x3d,0x3d,0x3d,0x3d,0x3d,0x27,0x28,0x28,0x2d,0x2c,0x45,0x34,0x35,0x10,0x20,0x22,0x10,0x10,0x10,0x10,0x10,0x27,0x2a,0x28,0x28,0x27,0x10,0x10,0x34,0x34,0x34,0x3d,0x3d,0x3d,0x3d,0x3d,0x10,0x27,0x2a,0x2a,0x2d,0x27,0x34,0x10,0x10,0x10,0x46,0x22,0x10,0x10,0x10,0x10,0x10,0x27,0x2a,0x28,0x28,0x27,0x10,0x10,0x34,0x3d,0x34,0x34,0x35,0x35,0x10,0x10,0x10,0x27,0x28,0x2d,0x2d,0x27,0x10,0x10,0x10,0x20,0x22,0x22,0x10,0x10,0x10,0x10,0x10,0x27,0x2a,0x28,0x28,0x27,0x10,0x30,0x34,0x3d,0x34,0x10,0x10,0x35,0x10,0x10,0x27,0x2d,0x2d,0x2d,0x2d,0x27,0x10,0x10,0x10,0x20,0x22,0x22,0x10,0x10,0x10,0x10,0x10,0x10,0x2c,0x28,0x28,0x2a,0x2c,0x34,0x34,0x3d,0x3d,0x35,0x10,0x35,0x10,0x10,0x27,0x2d,0x2d,0x2d,0x2c,0x10,0x10,0x10,0x20,0x22,0x22,0x22,0x10,0x10,0x10,0x10,0x10,0x10,0x27,0x2a,0x28,0x28,0x28,0x35,0x30,0x10,0x10,0x3d,0x35,0x35,0x10,0x10,0x27,0x2d,0x2d,0x2d,0x27,0x10,0x10,0x10,0x20,0x22,0x22,0x22,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x2b,0x28,0x28,0x28,0x35,0x10,0x10,0x10,0x10,0x34,0x10,0x10,0x10,0x27,0x2d,0x2d,0x27,0x10,0x30,0x30,0x20,0x22,0x22,0x22,0x22};
static uint8_t *cursor;
static uint8_t *close;
static uint8_t *img;

frame_t *bg_frame;
frame_t *cursor_frame;
frame_t *window_frame;
//frame_t *img_frame;

void bg_init() {
    uint16_t xsize=bg_frame->w;
    uint16_t ysize=bg_frame->h;
    uint8_t *vram =bg_frame->vram;

    fill_rect(vram, xsize, 0, 0, xsize, ysize - 28, COL_008484);
    fill_rect(vram, xsize, 0, ysize - 28, xsize, 1, COL_C6C6C6);
    fill_rect(vram, xsize, 0, ysize - 27, xsize, 1, COL_FFFFFF);
    fill_rect(vram, xsize, 0, ysize - 26, xsize, 26, COL_C6C6C6);

    fill_rect(vram, xsize, 3, ysize - 24, 57, 1, COL_FFFFFF);
    fill_rect(vram, xsize, 2, ysize - 24, 1, 21, COL_FFFFFF);
    fill_rect(vram, xsize, 3, ysize - 4, 57, 1, COL_848484);
    fill_rect(vram, xsize, 59, ysize - 23, 1, 19, COL_848484);
    fill_rect(vram, xsize, 2, ysize - 3, 58, 1, COL_000000);
    fill_rect(vram, xsize, 60, ysize - 24, 1, 22, COL_000000);

    fill_rect(vram, xsize, xsize - 47, ysize - 24, 44, 1, COL_848484);
    fill_rect(vram, xsize, xsize - 47, ysize - 23, 1, 20, COL_848484);
    fill_rect(vram, xsize, xsize - 47, ysize - 3, 44, 1, COL_FFFFFF);
    fill_rect(vram, xsize, xsize - 3, ysize - 24, 1, 22, COL_FFFFFF);

    draw_str(vram, xsize, 22, 22, "Hello World", COL_00FFFF);
    draw_block(vram,xsize,ysize,SCREEN_W-32,0,32,32,img);
}

void cursor_init() {
//    cursor_frame->flag|=FRAME_TOP; // 鼠标设置为最高
    cursor_frame->flag|=FRAME_ALPHA;// 鼠标包含透明图层
    cursor_frame->order=0xffff; // 设置为最高
    fill_alpha(cursor_frame->vram, cursor_frame->w, cursor_frame->h);
    draw_block(cursor_frame->vram, cursor_frame->w,cursor_frame->h, 0, 0, 16, 16, cursor);
}

void draw_window(uint8_t *vram, uint16_t w, uint16_t h, char *title) {
    fill_rect(vram, w, 0, 0, w, 1, COL_C6C6C6);
    fill_rect(vram, w, 1, 1, w - 2, 1, COL_FFFFFF);
    fill_rect(vram, w, 0, 0, 0, h, COL_C6C6C6);
    fill_rect(vram, w, 1, 1, 1, h - 2, COL_FFFFFF);
    fill_rect(vram, w, w - 2, 1, 1, h - 2, COL_848484);
    fill_rect(vram, w, w - 1, 0, 1, h, COL_000000);
    fill_rect(vram, w, 2, 2, w - 4, h - 4, COL_C6C6C6);
    fill_rect(vram, w, 3, 3, w - 6, 18, COL_000084);
    fill_rect(vram, w, 1, h - 2, w - 2, 1, COL_848484);
    fill_rect(vram, w, 0, h - 1, w, 1, COL_000000);

    draw_str(vram, w, 4, 4, title, COL_FFFFFF);
    draw_block(vram, w,h, w - 21, 5, 16, 14, close);
}

// draw_window 的关闭点击判断
bool_t window_close(frame_t *frame,int x,int y){
    int left=frame->x+frame->w-21;
    int right=left+16;
    int top=frame->y+5;
    int bottom=top+14;
    return x>=left&&x<=right&&y>=top&&y<=bottom;
}

void window_init() {
    draw_window(window_frame->vram,window_frame->w,window_frame->h,"WINDOW");
}

void draw_textbox(uint8_t *vram,uint16_t w,int minX, int minY, int maxX, int maxY, uint8_t col) {
    fill_rect(vram, w, minX - 2, minY - 3, maxX - minX + 4, 1, COL_848484);
    fill_rect(vram, w, minX - 3, minY - 3, 1, maxY - minY + 5, COL_848484);
    fill_rect(vram, w, minX - 3, maxY + 2, maxX - minX + 5, 1, COL_FFFFFF);
    fill_rect(vram, w, maxX + 2, minY - 3, 1, maxY - minY + 6, COL_FFFFFF);
    fill_rect(vram, w, minX - 1, minY - 2, maxX - minX + 2, 1, COL_000000);
    fill_rect(vram, w, minX - 2, minY - 2, 1, maxY - minY + 3, COL_000000);
    fill_rect(vram, w, minX - 2, maxY + 1, maxX - minX + 3, 1, COL_C6C6C6);
    fill_rect(vram, w, maxX + 1, minY - 2, 1, maxY - minY + 4, COL_C6C6C6);
    fill_rect(vram, w, minX - 1, minY - 1, maxX - minX + 2, maxY - minY + 2, col);
    // TODO
//    draw_line(vram,w,minX,minY,maxX,maxY,COL_0000FF);
}

void init_frame(){
    // 加载外部资源
    file_t *file= file_open("cursor.sp",FALSE);
    cursor= mem_alloc(256);
    file_read(file,256,cursor);
    file_close(file);
    file= file_open("close.sp",FALSE);
    close= mem_alloc(224);
    file_read(file,224,close);
    file_close(file);
    file= file_open("ctj.sp",FALSE);
    img= mem_alloc(1024);
    file_read(file,1024,img);
    file_close(file);
    for (int i = 0; i < FRAME_COUNT; ++i) {
        frames[i]= mem_alloc(sizeof(frame_t));
    }
    merge_vram= mem_alloc(VRAM_SIZE);
    curr_order=0;
    bg_frame= frame_alloc(0,0,SCREEN_W,SCREEN_H);
    bg_init();
//    window_frame= frame_alloc(SCREEN_W/4,SCREEN_H/4,SCREEN_W/2,SCREEN_H/2);
//    window_init();
    cursor_frame= frame_alloc(SCREEN_W/2,SCREEN_H/2,16,16);
    cursor_init();
    // 边框 28 8 8 9
//    img_frame= frame_alloc(SCREEN_W/2,SCREEN_H/2,48,69);
//    draw_window(img_frame->vram,img_frame->w,img_frame->h,"ctj.png");
    //    draw_block(img_frame->vram,img_frame->w,8,28,32,32,img);
    frame_refresh();
}

void frame_free(frame_t *frame){
    frame->used=FALSE;
    mem_free(frame->vram,(uint32_t)frame->w*(uint32_t)frame->h);
    fifo_free(&frame->kdb_fifo);
}

frame_t *frame_alloc(int x,int y,uint16_t w,uint16_t h){
    frame_t *frame=0;// 寻找并分配窗体
    for (int i = 0; i < FRAME_COUNT; ++i) {
        if(!frames[i]->used){
            frame=frames[i];
            frame->used=TRUE;
            break;
        }
    }
    if(!frame){
        return 0;
    }

    frame->vram= mem_alloc((uint32_t)w*(uint32_t)h);
    frame->x=x;
    frame->y=y;
    frame->w=w;
    frame->h=h;
    frame->order=curr_order++;// 默认新创建的在上面
    fifo_init(&frame->kdb_fifo,128);
    frame_sort();
    return frame;
}

void frame_top(frame_t *frame){ // 最好使用这个 不要直接修改 curr_order
    frame->order=curr_order++;
    frame_sort();
}

void frame_sort(){// order小的在前面 数量较少直接排序 循环获取第 i+1 小的放在位置i
    for (int i = 0; i < FRAME_COUNT - 1; ++i) {
        if(!frames[i]->used){
            continue;
        }
        for (int j = i+1; j < FRAME_COUNT; ++j) {
            if(frames[j]->used&&frames[j]->order<frames[i]->order){
                frame_t *frame=frames[i];
                frames[i]=frames[j];
                frames[j]=frame;
            }
        }
    }
}

// 用于部分移动的情况
void frame_move(frame_t *frame,int x,int y){
    int oldX=frame->x;
    int oldY=frame->y;
    frame->x=x;
    frame->y=y;
    // 新老位置都需要刷新
    frame_refresh_sub(oldX,oldY,frame->w,frame->h);
    frame_refresh_sub(x,y,frame->w,frame->h);
}

void draw_frame(frame_t *frame) {
    if(frame->flag&FRAME_ALPHA){
        draw_block_alpha(merge_vram, SCREEN_W,SCREEN_H, frame->x, frame->y, frame->w, frame->h, frame->vram);
    } else{
        draw_block(merge_vram, SCREEN_W,SCREEN_H, frame->x, frame->y, frame->w, frame->h, frame->vram);
    }
}

// 整体刷新
void frame_refresh(){// 已经确保排序了
    // 先绘制非置顶图像，再绘制置顶图像
    for (int i = 0; i < FRAME_COUNT; ++i) {
        if(frames[i]->used&&!(frames[i]->flag&FRAME_HIDE)){
            draw_frame(frames[i]);
        }
    }
    uint8_t *vram=(uint8_t *)VRAM_ADDR;
    mem_copy(vram, merge_vram, VRAM_SIZE);
}

void draw_frame_sub(int minX, int minY, int maxX, int maxY, frame_t *frame) {
    if(frame->flag&FRAME_ALPHA){
        draw_block_sub_alpha(merge_vram, SCREEN_W, minX, minY, maxX, maxY, frame->x, frame->y,
                             frame->w, frame->h, frame->vram);
    } else{
        draw_block_sub(merge_vram, SCREEN_W, minX, minY, maxX, maxY, frame->x, frame->y,
                       frame->w, frame->h, frame->vram);
    }
}

// 只刷新部分没有移动
void frame_refresh_sub(int x,int y,uint16_t w,uint16_t h){// 已经确保排序了
    // 进一步缩小边界
    int minX= max(x,0);
    int minY= max(y,0);
    int maxX= min(x+w,SCREEN_W);
    int maxY= min(y+h,SCREEN_H);
    if(minX>=maxX||minY>=maxY){
        return;
    }
    // 先绘制非置顶图像，再绘制置顶图像 只更新大于对应图层的信息
    for (int i = 0; i < FRAME_COUNT; ++i) {
        if(frames[i]->used&&!(frames[i]->flag&FRAME_HIDE)){
            draw_frame_sub(minX,minY,maxX,maxY,frames[i]);
        }
    }
    uint8_t *vram=(uint8_t *)VRAM_ADDR;
    for (int ty = minY; ty < maxY; ++ty) {
        mem_copy(vram+ty*SCREEN_W+minX,merge_vram+ty*SCREEN_W+minX,maxX-minX);
    }
}

frame_t *click_frame(int x,int y){
    // 越高越优先
    for (int i = FRAME_COUNT-1; i >=0 ; --i) {
        frame_t *frame=frames[i];
        if(frame->used&&(frame->flag&FRAME_CLICK)){
            if(x>=frame->x&&y>=frame->y&&x<=frame->x+frame->w&&y<=frame->y+frame->h){
                return frame;
            }
        }
    }
    return 0;
}